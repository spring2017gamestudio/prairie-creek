<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../view-behavior/view-behavior.html">
<link rel="import" href="../shared-styles/shared-styles.html">

<dom-module id="wudgie-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>
    <img src$="[[spiritView.image]]"></img>
    <br>
    {{spiritView.text}}
    <br>
    <paper-button raised on-tap="_next">[[buttonText]]</paper-button>
  </template>
  <script>
    Polymer({
      is: 'wudgie-view',
      behaviors: [ViewBehavior],
      properties: {
        mapData: {
          type: Object,
          notify: true
        },
        wudgieData: {
          type: Object,
          notify: true
        },
        spiritView: {
          type: Object,
          notify: true
        },
        buttonText: "Go to collections screen"
      },

      observers: [
        '_initSpiritView(routeData)'
      ],

      _initSpiritView: function(routeData) {
        if(routeData.page=="wudgie" && this.mapData == undefined) {
          this.buttonText = "Go to title page";
          this.spiritView = {
            text: 'Travel to Ball State to begin the experience.',
            image: '../../images/shadowSpirit.png'
          };
          return
        } else if (routeData.page=="wudgie" && this._visitedAllSites()) {
          this.buttonText = "Go to collections screen";
          this._setSpiritView(this.mapData,this.wudgieData);
        }
      },

      _setSpiritView: function(mapData,wudgieData) {
        var wudgieValue = 0;
        for(var i=0;i<mapData.length;i++) {
          for(var j=0;j<mapData[i].responses.length;j++) {
            wudgieValue += (mapData[i].responses[j].selected ? mapData[i].responses[j].value : 0);
          }
        }
        this.spiritView = {
          text: wudgieData[Math.sign(wudgieValue)+1].text,
          image: wudgieData[Math.sign(wudgieValue)+1].image
        };
      },

      _visitedAllSites: function() {
        for (var i = 0; i < this.mapData.length; i++) {
          if (!this.mapData[i].visited) {
            return false;
          }
        }
        return true;
      },

      _next: function() {
        this.nextPage = this._visitedAllSites() ? 'collection' : 'title';
        this._goToPage(this.nextPage);
      }
    });
  </script>
</dom-module>
