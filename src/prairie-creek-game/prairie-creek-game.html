<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../current-site/current-site.html">
<link rel="import" href="../map-data/map-data.html">
<link rel="import" href="../user-location/user-location.html">
<link rel="import" href="../shared-styles/shared-styles.html">
<link rel="import" href="../drop-menu/drop-menu.html">

<dom-module id="prairie-creek-game">
  <template>
    <style include="shared-styles">
      :host {
        font-family: var(--font-common-base);
      }
      
      drop-menu {
        position: fixed;
        top: 0px;
        right: 0px;
        z-index: 1;
      }
      
      iron-pages {
        background-color: var(--primary-background-color);
        position: relative;
        top: 0px;
        z-index: 0;
      }
    </style>
    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{tail}}"></app-route>
    <app-route route="{{tail}}" pattern="/:d" data="{{tailData}}"></app-route>
    <map-data data="{{mapData}}" spirit-data="{{spiritData}}"></map-data>
    <user-location active="[[gpsActive]]" latitude="{{latitude}}" longitude="{{longitude}}" dev-mode="[[devMode]]"></user-location>
    <current-site latitude="[[latitude]]" longitude="[[longitude]]" sites="[[mapData]]" site="{{currentSite}}"></current-site>
    <iron-localstorage name="my-app-storage" value="{{mapData}}">
    </iron-localstorage>
    <drop-menu on-reset="_resetGame"></drop-menu>

    <iron-pages id="pages" selected="[[routeData.page]]" attr-for-selected="name" on-iron-select="_onPageChanged">
      <title-view name="title" route-data="{{routeData}}"></title-view>
      <map-view name="map" locations="[[mapData]]" latitude="{{latitude}}" longitude="{{longitude}}" current-site="[[currentSite]]"
        route-data="{{routeData}}" dev-mode="[[devMode]]" gps-active>
      </map-view>
      <timer-view name="timer" prompt="[[currentSite.prompt]]" route-data="{{routeData}}" dev-mode="[[devMode]]">
      </timer-view>
      <checklist-view name="checklist" map-data="{{mapData}}" current-site="[[currentSite]]" route-data="{{routeData}}">
      </checklist-view>
      <spirit-view name="spirit" current-site="{{currentSite}}" spirit-data="[[spiritData]]" route-data="{{routeData}}"></spirit-view>
      <missing-view name="missing" route-data="{{routeData}}"></missing-view>
    </iron-pages>
  </template>

  <script>
      Polymer({
          is: 'prairie-creek-game',

          properties: {
              mapData: {
                type: Object,
                notify: true,
              },
              spiritData: {
                type: Object
              },
              route: {
                type: Object,
              },
              routeData: {
                type: Object,
                notify: true,
              },
              currentSite: {
                type: Object,
                notify: true
              },
              tailData: Object,
              devMode: {
                type: Boolean,
                notify: true,
                computed: '_checkDebugMode(tailData)'
              },
              gpsActive: {
                type: Boolean,
                value: false,
              }
          },

          observers: [
            '_onRoutePathChanged(route.path)',
            '_pageChanged(routeData.page)'
          ],

          _onRoutePathChanged: function(path) {
            // If we do not have an initial URL, redirect to title.
            if (!path) {
              this.set('route.path', '/title');
            }
          },

          _pageChanged: function(page) {
            var temp = this.mapData;
            this.mapData = [];
            this.mapData = temp;
            if (page) {
              if (page === 'title') {
                this.$$('map-data').reset();
              }

              var resolvedPageUrl = this.resolveUrl('../' + page + '-view/' + page + '-view.html');
              this.importHref(resolvedPageUrl, null, this._showPage404, true);
            }
          },

          _showPage404: function() {
              this.set('routeData.page', 'missing');
          },

          _onPageChanged: function(e) {
            this.gpsActive = this.$.pages.selectedItem.hasAttribute('gps-active');
          },

          _checkDebugMode: function(data) {
            if (data.d) {
              console.log('Debug mode enabled');
              return true;
            }
            else {
              return false;
            }
          },

          _resetGame: function(){
            this.set('route.path', '/title');
          }
      });
  </script>
</dom-module>
