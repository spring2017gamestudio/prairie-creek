<link rel="import"
      href="../../bower_components/polymer/polymer.html">
<link rel="import"
      href="../../bower_components/iron-timer/iron-timer.html">


<dom-module id="user-location">
  <template>
    <div>
      <iron-timer id="locationTimer"
                  start-time="[[updateRate]]"
                  current-time="0"
                  on-iron-timer-end="_onTimerEnd"></iron-timer>
    </div>
  </template>
  <script>
    Polymer({
      is: 'user-location',
      properties: {
        latitude: {
          type: Number,
          notify: true,
          readOnly: true
        },
        longitude: {
          type: Number,
          notify: true,
          readOnly: true
        },
        updateRate: {
          type: Number,
          notify: true,
          readOnly: true,
          value: 2
        },
        active: {
          type: Boolean,
          value: false
        },
        currentSite: {
          type: Object
        },
        devMode: {
          type: Boolean,
          notify: true
        },
      },

      observers: [
        '_devModeCheck(devMode)'
      ],

      ready: function () {
        // Don't do an active check here: we want to always acquire
        // our first location, no matter what view we are on.
        // The timer update function will check the active state for future
        // updates.
        this.$.locationTimer.start();
        this._updatePosition();
      },

      _updatePosition: function (position) {
        var that = this;
        navigator.geolocation.getCurrentPosition(function (position) {
          var coords = position.coords;
          that._setLatitude(coords.latitude);
          that._setLongitude(coords.longitude);
          if (document.location.host.startsWith('localhost')) {
            console.log('Latitude is ', that.latitude, ' and longitude is ', that.longitude);
          }
        });
      },

      _devModeCheck: function (devMode) {
        if (devMode == true) {
          this.$.locationTimer.pause();
        }
      },

      _onTimerEnd: function () {
        if (this.active) {
          this._updatePosition();
        }
        this.$.locationTimer.reset();
        this.$.locationTimer.start();
      }
    });
  </script>
</dom-module>