<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="user-location">
  <script>
    Polymer({
      is: 'user-location',
      properties: {
        latitude: {
          type: Number,
          notify: true,
          readOnly: true
        },
        longitude: {
          type: Number,
          notify: true,
          readOnly: true
        },
        updateRate: {
          type: Number,
          notify: true,
          readOnly: true,
          value: 2
        },
        active: {
          type: Boolean,
          value: false
        },
        currentSite: {
          type: Object
        },
        devMode: {
          type: Boolean,
          notify: true
        }
      },

      ready: function () {
        if ("geolocation" in navigator) {
          var that = this;
          navigator.geolocation.getCurrentPosition(this._updatePosition(), this._onError);
          navigator.geolocation.watchPosition(this._onPositionChanged(), this._onError);
        } else {
          alert('Geolocation not available on this device.');
          console.log('Geolocation not available');
        }
      },

      _onError: function (error) {
        console.log('Geolocation error(' + error.code + '): ' + error.message);
      },

      _onPositionChanged: function () {
        var that = this;
        return function (position) {
          if (that.devMode) {
            console.log('Ignoring location change; devmode')
          } else if (!that.active) {
            console.log('Ignoring location change; inactive');
          } else {
            that._updatePosition()(position);
          }
        }
      },

      _updatePosition: function () {
        var that = this;
        return function (position) {
          var coords = position.coords;
          that._setLatitude(coords.latitude);
          that._setLongitude(coords.longitude);
          console.log('Latitude is ', that.latitude, ' and longitude is ', that.longitude);
        }
      }
    });
  </script>
</dom-module>